<!DOCTYPE html>
<html>
<head>
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.1.6/css/ripples.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.1.6/css/material-wfont.min.css" rel="stylesheet">
</head>
<body>
  <div class="navbar navbar-default navbar-material-lime">
    <div class="navbar-header">
        <a class="navbar-brand" href="javascript:void(0)">TIM.io</a>
    </div>
  </div>
  <div class="container">
    <h1>TIM.io Test</h1>
    <audio id="audioyo" src="public/sample-beep.mp3"></audio>
    <button class="btn btn-material-lime">TIM.me</button>
     <i class="icon icon-material-favorite"></i>
     <img id="face">
    <section id="log">
    </section>
  </div>
  <video autoplay></video>
<canvas style="display:none;"></canvas>
<script>
  var video = document.querySelector('video');
  var canvas = document.querySelector('canvas');
  var ctx = canvas.getContext('2d');
  var localMediaStream = null;

  function generateThumbnail(i) {
      //generate thumbnail URL data
      var context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, 220, 150);
      var dataURL = canvas.toDataURL();

      //append img in container div
      document.getElementById('face').setAttribute('src', dataURL);
  }

  function snapshot() {
    if (localMediaStream) {


      ctx.drawImage(video, 0, 0);
      // "image/webp" works in Chrome.
      // Other browsers will fall back to image/png.
      //document.querySelector('#face').src = canvas.toDataURL('image/webp');
        generateThumbnail();

      setTimeout(function(){
        console.log('detecting in image');
        $("#face").objectdetect("all", {classifier: objectdetect.frontalface}, function(faces) {
          console.log('faces', faces);
          for (var i = 0; i < faces.length; ++i) {
            log('BAM Face<br/>');
            $(this).highlight(faces[i], "red");
            document.getElementById('audioyo').play();
            console.log('face:', faces[i]);
          }
        });
      }, 200);
      
    }
  }

  setInterval(function(){
    snapshot();
  }, 1000);

  function handleVideo(stream) {
    // if found attach feed to video element
    video.src = window.URL.createObjectURL(stream);
    localMediaStream = stream;
  }
 
  function videoError(e) {
    // no webcam found - do something
    console.log('cam error', e);
  }
  // check for getUserMedia support
  navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || navigator.oGetUserMedia;
 
  if (navigator.getUserMedia) {       
    // get webcam feed if available
    console.log('get user media');
    navigator.getUserMedia({video: true}, handleVideo, videoError);
  } else {
    console.log('darn');
  }

</script>
  <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
  <script type="text/javascript">
    //watch webcam
    //
    function log(txt){
      $('#log').append(txt);  
    }
    
    $('.btn').click(function(){
      log('OYOOO<br/>');
      document.getElementById('audioyo').play();
    })
  </script>
  <script src="js/objectdetect.js"></script>
  <script src="js/objectdetect.eye.js"></script>
  <script src="js/objectdetect.frontalface.js"></script>
  <script src="js/jquery.objectdetect.js"></script>
  
  <script>

  </script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.1.6/js/ripples.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.1.6/js/material.min.js"></script>
  <script>
      $(document).ready(function() {
          $.material.init();
      });
  </script>
  <script>
  $.fn.highlight = function(rect, color) {
    $("<div />", {
      "css": {
        "border":   "2px solid " + color,
        "position": "absolute",
        "left":   ($(this).offset().left + rect[0]) + "px",
        "top":    ($(this).offset().top  + rect[1]) + "px",
        "width":  rect[2] + "px",
        "height":   rect[3] + "px"
      }
    }).appendTo("body");
  };
  </script>
</body>
